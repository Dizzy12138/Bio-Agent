version: '3.8'

services:
  # Python FastAPI Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: biomedical-backend
    ports:
      - "8001:8001"
    volumes:
      - ./backend:/app
      - ./backend/logs:/app/logs  # 日志持久化
    environment:
      - ENVIRONMENT=production
      - MONGODB_URL=mongodb://admin:${MONGO_PASSWORD:-bioagent2024}@mongo:27017/?authSource=admin
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-bioagent2024}
      - POSTGRES_URL=postgresql://bioagent:${POSTGRES_PASSWORD:-bioagent2024}@postgres:5432/biomedical
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:5173}
    depends_on:
      - mongo
      - neo4j
      - postgres
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MongoDB (Document Store) - 安全加固
  mongo:
    image: mongo:6.0
    container_name: biomedical-mongo
    ports:
      - "127.0.0.1:27017:27017"  # 仅本地访问
    volumes:
      - mongo_data:/data/db
      - ./backend/scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD:-bioagent2024}
      - MONGO_INITDB_DATABASE=biomedical_platform
    restart: always
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 30s
      timeout: 10s
      retries: 3

  # Neo4j (Graph Database) - 安全加固
  neo4j:
    image: neo4j:5.15
    container_name: biomedical-neo4j
    ports:
      - "127.0.0.1:7474:7474"  # HTTP - 仅本地访问
      - "127.0.0.1:7687:7687"  # Bolt - 仅本地访问
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-bioagent2024}
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    restart: always
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "${NEO4J_PASSWORD:-bioagent2024}", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL + pgvector (Vector Store) - 安全加固
  postgres:
    image: ankane/pgvector:v0.5.1
    container_name: biomedical-postgres
    ports:
      - "127.0.0.1:5432:5432"  # 仅本地访问
    environment:
      - POSTGRES_USER=bioagent
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-bioagent2024}
      - POSTGRES_DB=biomedical
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/scripts/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bioagent -d biomedical"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  mongo_data:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  postgres_data:
    driver: local

networks:
  default:
    name: bioagent-network
